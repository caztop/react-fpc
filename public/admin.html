<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì í˜ì´ì§€</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background-color: #f9f9f9;
    }
    h1 {
      color: #333;
    }
    .post {
      border-bottom: 1px solid #ccc;
      margin-bottom: 15px;
      padding-bottom: 10px;
      background-color: #fff;
      padding: 10px;
      border-radius: 5px;
    }
    .post strong {
      font-size: 1.1em;
      color: #007acc;
    }
    .post small {
      color: #666;
      font-size: 0.9em;
    }
    .editable-content, strong[contenteditable="true"] {
      display: block;
      margin: 5px 0;
      padding: 5px;
      border: 1px dashed #ccc;
      border-radius: 3px;
      background-color: #fefefe;
    }
    button {
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <h1>ğŸ” ê´€ë¦¬ì ê²Œì‹œíŒ</h1>

  <div id="loginSection">
    <h2>ë¡œê·¸ì¸</h2>
    <form id="loginForm">
      <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required>
      <button type="submit">ë¡œê·¸ì¸</button>
    </form>
  </div>

  <div id="posts" style="display: none;">ë¡œë”© ì¤‘...</div>
  <button id="logoutBtn" style="display: none;">ë¡œê·¸ì•„ì›ƒ</button>
  <button id="downloadBtn" style="display: none;">ë¬¸ì˜ê¸€ ë‹¤ìš´ë¡œë“œ</button>

  <script>
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const password = document.getElementById('password').value;

      try {
        const res = await fetch('/admin-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ password })
        });

        const result = await res.json();

        if (res.ok && result.success) {
          document.getElementById('loginSection').style.display = 'none';
          document.getElementById('posts').style.display = 'block';
          loadPosts();
          document.getElementById('logoutBtn').style.display = 'block';
          document.getElementById('downloadBtn').style.display = 'block';
        } else {
          alert(result.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
        }
      } catch (err) {
        alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }

      document.getElementById('logoutBtn').style.display = 'block';
    });

    async function loadPosts() {
      try {
        const res = await fetch('/api/posts', {
          method: 'GET',
          credentials: 'include'
        });
        if (!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
        const posts = await res.json();
        const container = document.getElementById('posts');
        container.innerHTML = '';

        for (let i = posts.length - 1; i >= 0; i--) {
          const post = posts[i];
          const div = document.createElement('div');
          div.className = 'post';
          div.id = `post-${i}`;
          div.innerHTML = `
            <strong contenteditable="true">${post.title}</strong>
            <p contenteditable="true" class="editable-content">${post.content}</p>
            <small>${new Date(post.date).toLocaleString()}</small><br>
            <button onclick="updatePost(${i})">ìˆ˜ì •</button>
            <button onclick="deletePost(${i})">ì‚­ì œ</button>
          `;
          container.appendChild(div);
        } // âœ… for ë£¨í”„ ë‹«ê¸°

      } catch (err) {
        document.getElementById('posts').innerHTML = 'ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      }
    }

    async function deletePost(index) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      const res = await fetch(`/api/posts/${index}`, {
        method: 'DELETE',
        credentials: 'include'
      });
      if (res.ok) {
        alert('ì‚­ì œ ì™„ë£Œ');
        loadPosts();
      } else {
        alert('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    async function updatePost(index) {
      const postDiv = document.getElementById(`post-${index}`);
      const title = postDiv.querySelector('strong').textContent.trim();
      const content = postDiv.querySelector('.editable-content').textContent.trim();

      const res = await fetch(`/api/posts/${index}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ title, content })
      });

      if (res.ok) {
        alert('ìˆ˜ì • ì™„ë£Œ');
        loadPosts();
      } else {
        alert('ìˆ˜ì • ì‹¤íŒ¨');
      }
    }

    document.getElementById('downloadBtn').addEventListener('click', async function () {
    try {
      const res = await fetch('/api/posts', { credentials: 'include' });
      if (!res.ok) throw new Error('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
      const data = await res.json();

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'posts.json';
      a.click();
      URL.revokeObjectURL(url);
    } catch (err) {
      alert('ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  });

    document.getElementById('logoutBtn').addEventListener('click', async function () {
     try {
       const res = await fetch('/admin-logout', {
         method: 'POST',
        credentials: 'include'
       });

       if (res.ok) {
         alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
         location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ë³µê·€
       } else {
         alert('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨');
       }
     } catch (err) {
       alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
     }
   });
  </script>
</body>
</html>